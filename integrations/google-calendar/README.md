# Google Calendar API 連携ガイド

## 概要

Client Management AgentsはGoogle Calendar APIと連携し、日程調整・空き時間確認を行います。

**権限**: Read Only（読み取りのみ）

---

## 認証設定

### 1. Google Cloud Console設定

1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 新しいプロジェクトを作成（または既存プロジェクトを選択）
3. **APIとサービス** → **ライブラリ**
4. **Google Calendar API** を検索して有効化

### 2. OAuth 2.0認証情報の作成

1. **APIとサービス** → **認証情報**
2. **認証情報を作成** → **OAuth クライアント ID**
3. アプリケーションの種類: **デスクトップアプリ**
4. 認証情報をダウンロード（`credentials.json`）

### 3. 認証情報の配置

```bash
# 認証情報ファイルを配置
cp ~/Downloads/credentials.json ~/.config/client-agents/google-credentials.json
```

### 4. 初回認証

初回実行時にブラウザが開き、Googleアカウントでの認証を求められます。
認証後、トークンが自動的に保存されます。

---

## 使用エンドポイント

### Read Only（読み取りのみ）

| エンドポイント | 用途 | 使用エージェント |
|---------------|------|-----------------|
| `GET /freeBusy` | 空き時間確認 | SC |
| `GET /events` | 予定一覧取得 | SC |
| `GET /calendars/{id}` | カレンダー情報取得 | SC |

---

## 使用スコープ

```
https://www.googleapis.com/auth/calendar.readonly
```

**Read Onlyスコープのみ使用**（書き込みは行わない）

---

## データモデル

### FreeBusy（空き状況）

```json
{
  "timeMin": "2026-01-20T00:00:00Z",
  "timeMax": "2026-01-27T00:00:00Z",
  "calendars": {
    "primary": {
      "busy": [
        {
          "start": "2026-01-21T10:00:00+09:00",
          "end": "2026-01-21T11:00:00+09:00"
        },
        {
          "start": "2026-01-22T14:00:00+09:00",
          "end": "2026-01-22T15:30:00+09:00"
        }
      ]
    }
  }
}
```

### Event（予定）

```json
{
  "id": "event123",
  "summary": "クライアントMTG",
  "start": {
    "dateTime": "2026-01-21T10:00:00+09:00"
  },
  "end": {
    "dateTime": "2026-01-21T11:00:00+09:00"
  },
  "attendees": [
    {"email": "client@example.com"}
  ],
  "status": "confirmed"
}
```

---

## SC: Scheduler の使用方法

### 空き時間確認

```
リクエスト:
- 期間: 2026-01-20 〜 2026-01-27
- カレンダー: primary

レスポンス解析:
1. 指定期間のbusy時間を取得
2. 空き時間を計算
3. 候補日時を生成
```

### 候補日時生成ロジック

```
1. 営業時間内（9:00-18:00）をベースに
2. busy時間を除外
3. 優先ルールを適用:
   - 午前中は避ける（可能であれば）
   - 連続MTGを避ける（30分バッファ）
   - 月曜午前・金曜午後は避ける
4. 3-5個の候補を生成
```

---

## 日程調整ルール

### スケジューリングポリシー

| ルール | 内容 | 優先度 |
|--------|------|--------|
| 営業時間 | 9:00-18:00 | 必須 |
| バッファ | MTG前後30分 | 推奨 |
| 午前回避 | 10:00-12:00は避ける | 任意 |
| 曜日制限 | 月曜午前・金曜午後は避ける | 任意 |

### 緊急度別対応

| 緊急度 | 対応 |
|--------|------|
| 高 | 制限を緩和、最短の空き時間を提案 |
| 中 | 標準ルールを適用 |
| 低 | 理想的な時間帯を優先 |

---

## 出力フォーマット

### 日程調整結果

```markdown
## 日程調整: 〇〇社とのMTG

### 空き時間確認結果
- 確認期間: 2026-01-20 〜 2026-01-27
- 確認カレンダー: primary

### 候補日時（推奨順）

1. **2026-01-22（水）14:00-15:00** ⭐ 最推奨
   - 理由: 前後に余裕あり、週中の落ち着いた時間帯

2. **2026-01-23（木）15:30-16:30**
   - 理由: 午後の集中時間帯

3. **2026-01-24（金）10:00-11:00**
   - 理由: 金曜だが午前中に完了可能

### 注意事項
- 1/21（火）は終日予定あり
- 1/25-26は週末

### 提案メッセージ例
```
〇〇様

お打ち合わせの日程について、以下の候補はいかがでしょうか。

・1/22（水）14:00-15:00
・1/23（木）15:30-16:30
・1/24（金）10:00-11:00

ご都合の良い日時をお知らせください。
```
```

---

## エラーハンドリング

| エラー | 意味 | 対応 |
|--------|------|------|
| 401 | 認証エラー | トークン再取得 |
| 403 | 権限不足 | スコープ確認 |
| 404 | カレンダー不存在 | カレンダーID確認 |
| 429 | レート制限 | リトライ |

---

## レート制限

| 項目 | 制限 |
|------|------|
| クエリ/日 | 1,000,000（プロジェクト全体） |
| クエリ/ユーザー/100秒 | 100 |

通常の使用では問題にならない制限です。

---

## セキュリティ

### 必須事項

- 認証情報ファイルは安全な場所に保管
- `credentials.json` は `.gitignore` に追加
- Read Onlyスコープのみ使用

### 推奨事項

- 定期的なトークン更新
- 不要なカレンダーへのアクセスを制限

---

## 将来の拡張（予定）

現在はRead Onlyですが、将来的に以下の機能追加を検討：

- MTG予定の自動作成
- リマインダーの設定
- カレンダー招待の送信

**注意**: 書き込み機能を追加する場合は、スコープの変更と再認証が必要です。

---

## トラブルシューティング

### 認証エラー

```
確認事項:
1. credentials.json が正しい場所にあるか
2. OAuth同意画面が設定されているか
3. Calendar APIが有効化されているか
```

### 空き時間が取得できない

```
確認事項:
1. カレンダーIDが正しいか（primaryまたはメールアドレス）
2. 指定期間が正しいか
3. タイムゾーンの設定
```

---

## 参考リンク

- [Google Calendar API Documentation](https://developers.google.com/calendar/api/v3/reference)
- [OAuth 2.0 for Desktop Apps](https://developers.google.com/identity/protocols/oauth2/native-app)
