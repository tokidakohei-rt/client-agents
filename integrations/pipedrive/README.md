# Pipedrive API 連携ガイド

## 概要

Client Management AgentsはPipedrive CRMと連携し、クライアントデータの取得・更新を行います。

---

## 認証設定

### APIトークンの取得

1. Pipedriveにログイン
2. **設定** → **パーソナル設定** → **API**
3. **APIトークン**をコピー

### 環境変数の設定

```bash
# .bashrc / .zshrc に追加
export PIPEDRIVE_API_TOKEN="your-api-token-here"
export PIPEDRIVE_COMPANY_DOMAIN="your-company"  # your-company.pipedrive.com
```

### 設定ファイル（オプション）

`api-config.json` を作成（トークンは含めない）：

```json
{
  "base_url": "https://api.pipedrive.com/v1",
  "company_domain": "your-company",
  "rate_limit": {
    "requests_per_second": 10,
    "daily_limit": 8000
  }
}
```

---

## 使用エンドポイント

### Read（読み取り）

| エンドポイント | 用途 | 使用エージェント |
|---------------|------|-----------------|
| `GET /deals` | 商談一覧取得 | FM, CT |
| `GET /deals/{id}` | 商談詳細取得 | CT, EX |
| `GET /pipelines` | パイプライン一覧 | FM |
| `GET /stages` | ステージ一覧 | FM |
| `GET /persons` | 担当者一覧 | CT, CM |
| `GET /persons/{id}` | 担当者詳細 | CT, EX |
| `GET /organizations` | 企業一覧 | CT |
| `GET /organizations/{id}` | 企業詳細 | CT |
| `GET /activities` | アクティビティ一覧 | CT, CM, RP |
| `GET /notes` | ノート一覧 | CT, RP |

### Write（書き込み）- 確認必須

| エンドポイント | 用途 | 使用エージェント |
|---------------|------|-----------------|
| `PUT /deals/{id}` | 商談更新（ステージ移動等） | EX |
| `POST /activities` | アクティビティ作成 | EX |
| `POST /notes` | ノート追加（アクションログ） | EX |

---

## データモデル

### Deal（商談）

```json
{
  "id": 1,
  "title": "商談タイトル",
  "value": 100000,
  "currency": "JPY",
  "stage_id": 1,
  "pipeline_id": 1,
  "person_id": 1,
  "org_id": 1,
  "status": "open",
  "expected_close_date": "2026-02-15",
  "add_time": "2026-01-15 10:00:00",
  "update_time": "2026-01-20 14:30:00"
}
```

### Person（担当者）

```json
{
  "id": 1,
  "name": "山田太郎",
  "email": [{"value": "yamada@example.com", "primary": true}],
  "phone": [{"value": "03-1234-5678", "primary": true}],
  "org_id": 1
}
```

### Activity（アクティビティ）

```json
{
  "id": 1,
  "type": "call",
  "subject": "フォローアップ電話",
  "due_date": "2026-01-21",
  "due_time": "14:00",
  "done": false,
  "deal_id": 1,
  "person_id": 1
}
```

### Note（ノート）

```json
{
  "id": 1,
  "content": "ノート内容",
  "deal_id": 1,
  "person_id": 1,
  "add_time": "2026-01-20 15:00:00"
}
```

---

## エージェント別API使用

### FM: Funnel Monitor

```
使用エンドポイント:
- GET /pipelines（パイプライン一覧）
- GET /stages（ステージ一覧）
- GET /deals（商談一覧、フィルタ付き）

フィルタ例:
- status=open（進行中の商談のみ）
- pipeline_id=1（特定パイプライン）
```

### CT: Client Triager

```
使用エンドポイント:
- GET /deals/{id}（商談詳細）
- GET /persons/{id}（担当者詳細）
- GET /organizations/{id}（企業詳細）
- GET /activities?deal_id={id}（関連アクティビティ）
- GET /notes?deal_id={id}（関連ノート）
```

### RP: Risk Predictor

```
使用エンドポイント:
- GET /activities（アクティビティ履歴）
- GET /notes（ノート履歴）
- GET /deals（商談情報）

分析ポイント:
- 最終アクティビティからの経過日数
- アクティビティの頻度推移
- ノートの内容（ネガティブキーワード検出）
```

### EX: Executor

```
使用エンドポイント（Read）:
- GET /deals/{id}（現在の状態確認）
- GET /persons/{id}（担当者情報）

使用エンドポイント（Write）- 確認必須:
- PUT /deals/{id}（ステージ移動）
- POST /activities（タスク・MTG作成）
- POST /notes（アクションログ記録）
```

---

## アクションログ形式

### ノート追加時のフォーマット

```markdown
## 🤖 Agent Action Log

| 項目 | 内容 |
|------|------|
| **Timestamp** | 2026-01-20 15:30:00 |
| **Agent** | EX (Executor) |
| **Action** | フォローアップメール作成 |

### Details
- 作成したメール: 提案後フォローアップ
- 送信予定: 2026-01-21
- 次のアクション: 3営業日後に電話フォロー

### Confidence
High

---
*This log was automatically generated by Client Management Agents*
```

---

## レート制限

| 項目 | 制限 |
|------|------|
| リクエスト/秒 | 10 |
| 日次リクエスト | 8,000（プランにより異なる） |

### レート制限対策

- バッチリクエストの活用
- キャッシュの利用（短期間の重複リクエスト回避）
- 429エラー時のリトライ（指数バックオフ）

---

## エラーハンドリング

| ステータス | 意味 | 対応 |
|-----------|------|------|
| 200 | 成功 | - |
| 400 | リクエスト不正 | パラメータ確認 |
| 401 | 認証エラー | APIトークン確認 |
| 403 | 権限不足 | アクセス権限確認 |
| 404 | リソース不存在 | ID確認 |
| 429 | レート制限 | リトライ（バックオフ） |
| 500 | サーバーエラー | 時間をおいてリトライ |

---

## セキュリティ

### 必須事項

- APIトークンは環境変数で管理（コードに含めない）
- `.env` ファイルは `.gitignore` に追加
- 書き込み操作前にユーザー確認

### 推奨事項

- 定期的なAPIトークンの更新
- 最小権限の原則（必要な権限のみ）
- 操作ログの保持

---

## トラブルシューティング

### 認証エラー（401）

```
確認事項:
1. PIPEDRIVE_API_TOKEN が正しく設定されているか
2. トークンが有効期限内か
3. トークンに必要な権限があるか
```

### レート制限（429）

```
対応:
1. リクエスト頻度を下げる
2. バッチAPIを活用
3. レスポンスヘッダーの Retry-After を確認
```

### データ不整合

```
確認事項:
1. IDが正しいか
2. フィルタ条件が正しいか
3. 削除されたリソースを参照していないか
```

---

## 参考リンク

- [Pipedrive API Documentation](https://developers.pipedrive.com/docs/api/v1)
- [Pipedrive API Reference](https://developers.pipedrive.com/docs/api/v1/reference)
