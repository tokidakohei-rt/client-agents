# Workflows - 典型ワークフロー定義 v1.0

## 概要

このドキュメントは、よく使われるタスクフローを事前定義し、
一気通貫での実行を可能にするためのワークフロー定義です。

ユーザーがワークフロー名を指定すると、DPはこのフローに従ってエージェントを順次起動します。

---

## ワークフロー一覧

| ID | 名前 | 用途 | 想定時間 |
|----|------|------|---------|
| WF-001 | 日次レビュー | 毎日のファネル・クライアント確認 | 5-10分 |
| WF-002 | クライアント介入 | 特定クライアントへの対応 | 10-15分 |
| WF-003 | リスクスキャン | チャーンリスクの早期発見 | 5-10分 |
| WF-004 | フォローアップ実行 | 溜まったフォローアップの処理 | 10-20分 |
| WF-005 | 週次サマリー | 週次の振り返りとプランニング | 15-20分 |
| WF-006 | クライアント360°ビュー | PD+Slack+Email統合情報 | 5-10分 |
| WF-007 | Slackサマリー | 営業チャンネル活動まとめ | 5分 |

---

## WF-001: 日次レビュー

### 目的
毎日のファネル状況とアクション必要なクライアントを確認し、優先アクションを実行する。

### トリガー
- 「日次レビュー」「今日の状況」「デイリーチェック」

### フロー

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│   DP    │ → │   FM    │ → │   CT    │ → │   EX    │ → │   RV    │
│ 振り分け │    │ファネル │    │クライアント│    │アクション│    │ レビュー │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
                   │              │              │
                   ▼              ▼              ▼
              ボトルネック    要対応リスト    即実行 or
              特定           優先度付き      アクション提案
```

### 各ステップの詳細

#### Step 1: DP（ディスパッチャー）
- タスクタイプ: 定型
- 出力: WF-001を認識、FMを起動

#### Step 2: FM（ファネルモニター）
- 入力: なし（全パイプライン対象）
- 出力:
  - ファネル概要
  - ボトルネック
  - 要注意クライアントリスト（上位5件）
- 次アクション提案:
  - 各クライアントの詳細診断
  - 特定ステージの深掘り

#### Step 3: CT（クライアントトリアージャー）
- 入力: FMが特定した要注意クライアント
- 出力:
  - 各クライアントの診断
  - ヘルススコア
  - 推奨アクション（優先度付き）
- 次アクション提案:
  - 各クライアントへの具体的アクション

#### Step 4: EX（エグゼキューター）
- 入力: CTの推奨アクション
- 出力:
  - 承認不要アクション → 即実行
  - 承認必要アクション → 提案のみ
- 次アクション提案:
  - 追加のクライアント対応
  - 完了

#### Step 5: RV（レビュワー）
- 入力: 全ステップの出力
- 出力:
  - 日次サマリー
  - 残タスク
  - 明日への引き継ぎ

### ユーザー介入ポイント

| ステップ | 介入 | 内容 |
|---------|------|------|
| FM→CT | 選択 | どのクライアントを詳しく見るか |
| CT→EX | 選択 | どのアクションを実行するか |
| EX実行 | 承認 | 承認必要アクションのみ |

---

## WF-002: クライアント介入

### 目的
特定のクライアントに対して、診断→リスク評価→アクション実行までを一気通貫で行う。

### トリガー
- 「[クライアント名]の対応」「[クライアント名]をケア」
- 「介入」「フォローアップ」+ クライアント名

### フロー

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│   DP    │ → │   CT    │ → │   RP    │ → │   CM    │ → │   EX    │ → │   RV    │
│ 振り分け │    │ 診断    │    │ リスク  │    │コミュ最適│    │ 実行    │    │ レビュー │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 各ステップの詳細

#### Step 1: DP
- 対象クライアントを特定
- WF-002を認識

#### Step 2: CT（クライアントトリアージャー）
- 入力: クライアント名/ID
- 出力:
  - クライアント詳細プロファイル
  - ヘルススコア（詳細内訳）
  - 直近のアクティビティ・メール
  - 推奨アクション

#### Step 3: RP（リスクプレディクター）
- 入力: CTの診断結果
- 出力:
  - リスクスコア
  - 早期警告サイン
  - 介入しない場合のリスク
  - 推奨介入タイミング

#### Step 4: CM（コミュニケーションマネージャー）
- 入力: CT + RPの結果
- 出力:
  - 最適なコミュニケーションチャネル
  - 最適なタイミング
  - メッセージトーン
  - パーソナライズポイント

#### Step 5: EX（エグゼキューター）
- 入力: CT + RP + CMの結果
- 出力:
  - アクション実行（承認不要は即実行）
  - メール下書き
  - フォローアップ設定

#### Step 6: RV（レビュワー）
- 入力: 全ステップ
- 出力: 介入サマリー、次回フォローアップ日

### ユーザー介入ポイント

| ステップ | 介入 | 内容 |
|---------|------|------|
| CT後 | 確認 | 診断結果の確認（スキップ可） |
| EX実行 | 承認 | メール送信等の承認必要アクション |

---

## WF-003: リスクスキャン

### 目的
全クライアントのチャーンリスクをスキャンし、早期警告を発見する。

### トリガー
- 「リスクスキャン」「チャーンチェック」「解約リスク確認」

### フロー

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│   DP    │ → │   RP    │ → │   CT    │ → │   RV    │
│ 振り分け │    │全体スキャン│    │上位詳細 │    │サマリー │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 各ステップの詳細

#### Step 1: DP
- WF-003を認識

#### Step 2: RP（リスクプレディクター）
- 入力: 全アクティブクライアント
- 出力:
  - リスクスコアランキング
  - High Risk クライアントリスト
  - 早期警告サイン一覧
- 次アクション提案:
  - 各High Riskクライアントの詳細診断

#### Step 3: CT（クライアントトリアージャー）
- 入力: RPが特定したHigh Riskクライアント（上位3-5件）
- 出力:
  - 詳細診断
  - 推奨介入アクション
- 次アクション提案:
  - WF-002（クライアント介入）への移行

#### Step 4: RV（レビュワー）
- 入力: 全ステップ
- 出力:
  - リスクサマリー
  - 介入優先度リスト
  - 推奨アクションまとめ

---

## WF-004: フォローアップ実行

### 目的
設定済みのフォローアップタスクを一括で処理する。

### トリガー
- 「フォローアップ」「タスク処理」「今日のタスク」

### フロー

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│   DP    │ → │   CT    │ → │   EX    │ → │   RV    │
│ 振り分け │    │タスク確認│    │ 実行    │    │サマリー │
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 各ステップの詳細

#### Step 1: DP
- WF-004を認識

#### Step 2: CT（クライアントトリアージャー）
- 入力: 今日のアクティビティ（due_date = today）
- 出力:
  - 今日のフォローアップリスト
  - 各タスクのクライアント状況
  - 優先度付け
- 次アクション提案:
  - 各タスクの実行

#### Step 3: EX（エグゼキューター）
- 入力: フォローアップリスト
- 出力:
  - タスク完了処理
  - メール下書き作成
  - 次回フォローアップ設定
- 次アクション提案:
  - 追加タスク
  - 完了

#### Step 4: RV（レビュワー）
- 入力: 全ステップ
- 出力:
  - 完了タスクサマリー
  - 残タスク
  - 明日のタスクプレビュー

---

## WF-005: 週次サマリー

### 目的
週の振り返りと来週のプランニング。

### トリガー
- 「週次サマリー」「週次レビュー」「今週の振り返り」

### フロー

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│   DP    │ → │   FM    │ → │   CT    │ → │   RP    │ → │   SA    │ → │   RV    │
│ 振り分け │    │週次ファネル│    │週次クライアント│    │週次リスク│    │🎯戦略評価│    │統合サマリー│
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

### 各ステップの詳細

#### Step 2: FM
- 出力:
  - 週次ファネル変動
  - CVR推移
  - 今週のWon/Lost

#### Step 3: CT
- 出力:
  - 今週対応したクライアント
  - ヘルススコア変動
  - 来週要対応クライアント

#### Step 4: RP
- 出力:
  - リスクスコア変動
  - 新規High Riskクライアント
  - 改善したクライアント

#### Step 5: SA（Strategy Advisor）🆕
- 入力: FM + CT + RPの全出力
- 出力:
  - **戦略評価サマリー**（ファネル健全性、リソース配分、成長ポテンシャル）
  - **クリティカルな指摘**（忖度しない評価）
  - **軌道修正の提案**（現状→推奨→期待効果）
  - **中長期的な観点**（3ヶ月後を見据えた提言）

#### Step 6: RV
- 出力:
  - 週次サマリーレポート（SA指摘を含む）
  - 来週の優先事項
  - KPI進捗

---

## ワークフロー実行ルール

### 1. 開始方法

ユーザーは以下のいずれかで開始:

```
# ワークフロー名で開始
「日次レビューをお願い」
「WF-001を実行」

# 自然言語で開始（DPが判定）
「今日のファネル状況と対応すべきクライアントを教えて」
→ DPがWF-001と判定
```

### 2. 途中スキップ

各ステップ後に「スキップ」「次へ」で次ステップに進める:

```
FM完了後:
「Client Aだけ詳しく見て」→ CTでClient Aのみ実行
「スキップしてアクションへ」→ EXへジャンプ
```

### 3. 途中離脱

「完了」「終了」「ここまででOK」で途中終了:

```
CT完了後:
「ここまででOK」→ 現時点のサマリーを出力して終了
```

### 4. 分岐・追加

ワークフロー中に別のワークフローを開始可能:

```
WF-001実行中:
「Client Aに介入して」→ WF-002をClient Aで開始
```

---

## コンテキスト引き継ぎ

### 自動引き継ぎ項目

| 項目 | 説明 |
|------|------|
| workflow_id | 実行中のワークフローID |
| current_step | 現在のステップ番号 |
| target_clients | 対象クライアントリスト |
| previous_outputs | 前ステップの出力サマリー |
| user_selections | ユーザーの選択履歴 |
| executed_actions | 実行済みアクション |

### 引き継ぎフォーマット

```yaml
context:
  workflow_id: WF-001
  current_step: 3
  target_clients:
    - id: 123
      name: "Client A"
      health_score: 45
  previous_outputs:
    fm:
      bottleneck: "Proposal → Won"
      at_risk_clients: [123, 456]
    ct:
      client_123:
        health_score: 45
        recommended_action: "フォローアップメール"
  user_selections:
    - step: 2
      selected: "client_123を詳しく"
  executed_actions:
    - type: "note_add"
      target: "deal_789"
      timestamp: "2026-01-20T10:30:00"
```

---

## 出力保存

ワークフロー完了時、自動的に保存:

```
/client-agents/outputs/
  └── WF-001_20260120/
      ├── 00_summary.md
      ├── 01_funnel-report.md
      ├── 02_client-diagnostics.md
      └── 03_executed-actions.md
```

---

## WF-006: クライアント360°ビュー

### 目的
特定クライアントのPipedrive + Slack + Email情報を統合し、360°の最新状況を把握する。

### トリガー
- 「[クライアント名]の全体像」「[クライアント名]の360度ビュー」
- 「[クライアント名]の最新状況（詳細）」

### フロー

```
┌─────────┐    ┌─────────┐    ┌─────────┐
│   DP    │ → │   CT    │ → │   RV    │
│ 振り分け │    │ 360°収集 │    │サマリー │
└─────────┘    └─────────┘    └─────────┘
                   │
         ┌────────┼────────┐
         ▼        ▼        ▼
     Pipedrive  Slack    Email
        API      MCP    (via PD)
```

### 各ステップの詳細

#### Step 1: DP
- WF-006を認識
- 対象クライアント名を特定

#### Step 2: CT（クライアントトリアージャー）with Slack統合
- **Pipedrive取得**:
  - Organization/Person基本情報
  - Deal情報（ステージ、金額、期待受注日）
  - Notes（直近のメモ）
  - Activities（予定、完了タスク）
  - Mail Messages（同期済みメール）
  
- **Slack検索（MCP）**:
  ```
  slack_search_messages:
    query: "{company_name}"
    after: "{7日前}"
    in_channel: "sales"
  ```
  - 関連スレッドの特定
  - スレッド詳細取得
  
- **出力**:
  - 統合タイムライン
  - クライアント360°ビュー
  - Slackの議論サマリー
  - 次のアクション提案

#### Step 3: RV（レビュワー）
- 情報の整合性確認
- 抜け漏れチェック
- 最終サマリー

### 出力フォーマット

```markdown
## 360°ビュー: [クライアント名]

### 基本情報
| 項目 | 内容 |
|------|------|
| 企業名 | [name] |
| Deal | [stage] / ¥[amount] |
| 期待受注日 | [date] |
| 担当 | [owner] |

### 統合タイムライン（直近7日）
| 日付 | ソース | 内容 |
|------|--------|------|
| 1/22 | 📧 Email | 見積もりについて返信 |
| 1/21 | 💬 Slack | #sales で価格交渉の議論 |
| 1/20 | 📝 Note | フォローアップ完了 |
| 1/19 | 📅 Activity | デモ実施 |

### Slack上の議論
**#sales** (1/21)
> 「ABC社の価格交渉について、10%値引きで進めてよいか」
> → スレッド: 3件の返信、「OK、進めて」で合意

### Email状況
- 最新: 1/22 先方から返信あり（未読）
- 未返信: 1件

### 推奨アクション
1. ⚠️ **メール返信**: 1/22の問い合わせに対応
2. 📝 **Slack報告**: 価格交渉結果を#salesに共有
```

---

## WF-007: Slackサマリー

### 目的
営業関連チャンネルの活動をサマリーし、重要な議論や対応必要な項目を抽出する。

### トリガー
- 「Slackまとめ」「営業チャンネルの状況」
- 「今日のSlack」「Slack何かあった？」

### フロー

```
┌─────────┐    ┌─────────┐    ┌─────────┐
│   DP    │ → │   FM    │ → │   RV    │
│ 振り分け │    │ Slack分析│    │サマリー │
└─────────┘    └─────────┘    └─────────┘
                   │
                   ▼
              Slack MCP
         slack_get_channel_history
         slack_search_messages
```

### 各ステップの詳細

#### Step 1: DP
- WF-007を認識
- 対象期間を特定（デフォルト: 今日）

#### Step 2: FM（ファネルモニター）with Slack
- **チャンネル履歴取得**:
  ```
  slack_get_channel_history:
    channel: {sales_channel_id}
    limit: 50
  ```
  
- **重要キーワード検索**:
  ```
  slack_search_messages:
    query: "緊急 OR 至急 OR 確認お願い OR 対応お願い"
    after: "{today}"
    in_channel: "sales"
  ```

- **出力**:
  - 今日の投稿数・参加者
  - 重要な議論トピック
  - 対応が必要なリクエスト
  - クライアント関連の言及

#### Step 3: RV
- 抽出項目の妥当性確認
- 優先度付け

### 出力フォーマット

```markdown
## Slackサマリー: [日付]

### 概要
- 📊 **投稿数**: 23件
- 👥 **参加者**: 5名
- 🔥 **重要スレッド**: 3件

### 重要な議論
1. **ABC社 価格交渉** (10:30)
   - 概要: 10%値引きの承認依頼
   - 結論: 承認済み
   - スレッド: [リンク]

2. **XYZ社 緊急対応** (14:15) ⚠️
   - 概要: システム障害の報告
   - ステータス: 対応中
   - 担当: [name]

### 対応が必要
| クライアント | 内容 | 依頼者 | 緊急度 |
|-------------|------|--------|--------|
| XYZ社 | 障害対応 | tanaka | 🔴 High |
| DEF社 | 見積もり確認 | suzuki | 🟡 Medium |

### クライアント言及
- ABC社: 3回
- XYZ社: 2回
- DEF社: 1回

### 📋 次のアクション
| # | アクション | 説明 |
|---|-----------|------|
| 1 | 🔍 XYZ社を詳しく診断 | 緊急対応が必要 |
| 2 | 📧 DEF社に見積もり送付 | Slackで依頼あり |
| 3 | ✅ 完了 | サマリーのみ |
```

---

## データソース統合ルール

### 優先度
情報が重複・矛盾する場合の優先順位:

| 優先度 | ソース | 理由 |
|--------|--------|------|
| 1 | Pipedrive | マスターデータ |
| 2 | Email | 公式コミュニケーション |
| 3 | Slack | 社内議論（参考） |

### タイムライン統合
全ソースを時系列で統合する際のフォーマット:

```
📧 Email    → メール送受信
💬 Slack   → Slack投稿・返信
📝 Note    → Pipedriveノート
📅 Activity → アクティビティ
🎯 Deal    → ステージ変更
```

### 検索クエリのベストプラクティス

**クライアント検索**:
```
# Slack: 会社名で検索（表記ゆれ対応）
query: "ABC社 OR ABC株式会社 OR エービーシー"

# Pipedrive: Organization検索
GET /organizations?term=ABC
```

**期間指定**:
```
# Slack: 相対日付
after: "2026-01-15"  # YYYY-MM-DD形式

# Pipedrive: recents API
GET /recents?since_timestamp={unix_timestamp}
```
