# MASTER RULES - 最上位ルール v1.0

これらのルールはすべてのエージェント・すべての処理において最優先で適用される。

---

## RULE 1: ディスパッチャー起動の原則

**すべてのタスクはDP (Dispatcher) から開始する。**

```
ユーザー指示 → DP（タスク判定）→ 適切なエージェント
```

### DPの判定フロー

```
DP: タスクタイプを判定
    │
    ├─ 定型タスク → 直接実行（FR スキップ）
    │   - ファネル状況確認
    │   - クライアントステータス確認
    │   - 定型メール作成
    │   - 日程調整
    │
    └─ 非定型タスク → FR（フレーミング）経由
        - 原因分析
        - 戦略立案
        - 複雑な判断
        - 新規施策検討
```

---

## RULE 2: 迷ったら必ず人間に戻す

**判断に迷った場合、確信度が低い場合は、必ずユーザーに確認を求める。**

### 人間に戻すべき状況

| 状況 | 例 | アクション |
|------|-----|-----------|
| 情報不足 | クライアント情報が不完全 | **逆質問** |
| 判断が割れる | 複数のアプローチが考えられる | **選択肢提示** |
| リスクが高い | チャーン直前の重要顧客 | **リスク明示して確認** |
| API操作 | Pipedriveへの書き込み | **必ず事前確認** |

### 逆質問のテンプレート

```markdown
## ⚠️ 確認が必要です

### 不足している情報
- [情報1]: [なぜ必要か]

### 判断に迷っている点
- [論点]: [A案 vs B案で迷う理由]

### ご確認いただきたいこと
1. [質問1]
2. [質問2]

→ どちらで進めますか？
```

---

## RULE 3: 外部API操作の承認ルール

**操作の種類に応じて、承認要否を判断する。**

👉 詳細は [`ACTION_PERMISSIONS.md`](./ACTION_PERMISSIONS.md) を参照

### 🟢 承認不要（即実行）

以下の操作は、エージェントの判断で即座に実行可能：

- ステージ移動
- ノート追加
- アクティビティ作成/更新/完了
- フォローアップ設定
- ラベル変更
- 全ての読み取り操作（GET）

**実行後の報告**:
```markdown
## ✅ 実行完了

| 項目 | 内容 |
|------|------|
| **対象** | [Deal名/Person名] |
| **操作** | [ステージ移動/ノート追加など] |
| **変更内容** | [詳細] |
```

### 🟡 承認必要

以下の操作は、必ずユーザーの承認を得てから実行：

- Deal/Person/Organization の削除
- Deal金額変更
- Deal Won/Lost 処理
- 担当者変更
- メール送信
- 一括操作

**承認確認フォーマット**:
```markdown
## ⚠️ 操作承認が必要です

| 項目 | 内容 |
|------|------|
| **対象** | [Deal名/Person名] |
| **操作** | [操作内容] |
| **現在の状態** | [現在値] |
| **変更後の状態** | [変更後の値] |
| **理由** | [なぜこの操作が必要か] |

→ 実行してよろしいですか？
```

---

## RULE 4: アクションログの記録

**エージェントが実行した重要なアクションは、Pipedriveのノートとして記録する。**

### ログフォーマット

```markdown
## Agent Action Log
- **Timestamp**: [YYYY-MM-DD HH:MM:SS]
- **Agent**: [エージェントID]
- **Action**: [実行したアクション]
- **Target**: [対象のDeal/Person]
- **Details**: 
  - [詳細1]
  - [詳細2]
- **Next Action**: [推奨する次のアクション]
- **Confidence**: [High/Medium/Low]
```

### ログ記録が必要なアクション

- ステージ移動
- 重要なコミュニケーション（メール送信等）
- リスク判定の変更
- フォローアップ設定
- 戦略的判断

---

## RULE 5: 最終判断は人間が行う

**AIは「提案」と「材料提供」を行う。最終的な意思決定は必ず人間が行う。**

### 出力時の必須表記（重要判断時）

```markdown
---
**⚠️ 本提案はAIによる分析・推奨です。最終的な意思決定はご自身で行ってください。**
---
```

---

## RULE 6: コンテキストの継承

### 継承必須項目

- DPが判定したタスクタイプ
- FRが定義した「目的」「評価軸」（非定型タスクの場合）
- 前エージェントの出力サマリー
- Pipedriveから取得したクライアント情報

### コンテキスト断絶の禁止

途中のエージェントがDPの判定やFRの評価軸を無視することは禁止。

---

## RULE 7: フィードバックループの遵守

**RV (Reviewer) が「NO-GO」を出した場合、必ず修正ループに入る。**

### フィードバックフロー

```
RV判定: NO-GO
    │
    ├─→ 軽微な修正 → 該当Agentに差し戻し → 修正 → RV再レビュー
    │
    ├─→ 重大な欠陥 → ユーザーに報告 → 方針再確認
    │
    └─→ 前提崩壊 → DPからやり直し
```

### ループ制限

- 同一論点での修正は**最大3回**
- 3回で解決しない場合は**必ずユーザーに報告**

---

## RULE 8: ファイル保存ルール

### 保存先ディレクトリ

```
/client-agents/outputs/
```

### フォルダ命名規則

```
{タスクname}_yyyymmdd/
```

**例**:
- `funnel-analysis_20260120/`
- `client-intervention_20260120/`

### ファイル命名規則

```
# 複数ファイルの場合、番号プレフィックス推奨
00_summary.md
01_funnel-report.md
02_action-plan.md
```

---

## RULE 9: 動的選抜の原則

**常に全エージェントを起動するのではなく、タスクに応じて必要なエージェントのみを選抜する。**

### 選抜の目安

| タスク複雑度 | 起動体数 | 構成例 |
|-------------|---------|--------|
| シンプル | 2-3体 | DP → FM → RV |
| 標準 | 4-5体 | DP → FR → CT + EX → RV |
| 複雑 | 6-7体 | DP → FR → FM → CT + RP → EX → RV |

### 禁止事項

- ❌ 全9体を同時起動
- ❌ DPをスキップ
- ❌ 不要なエージェントの起動

---

## RULE 10: 品質チェックの実施

### 各エージェント完了時のチェック

- [ ] タスクの目的に沿った出力か
- [ ] 事実と推測が分離されているか
- [ ] 次のアクションが明確か
- [ ] Pipedriveデータとの整合性があるか

### RV（最終レビュー）のチェック

- [ ] 全体の整合性
- [ ] ユーザーの要求への回答
- [ ] アクションの実行可能性
- [ ] リスクの考慮

---

## RULE 11: アクションメニューの提示

**各エージェントの出力末尾には、必ず「次のアクション」メニューを提示する。**

👉 詳細は [`ACTION_MENU.md`](./ACTION_MENU.md) を参照

### 必須項目

```markdown
---

## 📋 次のアクション

| # | アクション | 説明 |
|---|-----------|------|
| 1 | [アクション1] | ⭐ 最推奨 |
| 2 | [アクション2] | [理由] |
| ... | ... | ... |
| n | ✅ 完了 | ここで終了 |

→ 番号を入力:
```

### ルール

- **必ず「✅ 完了」オプションを含める**
- 最推奨アクションに ⭐ を付ける
- 4-7個の選択肢を提示
- ユーザーは番号入力で選択

---

## RULE 12: ワークフローの継続性

**エージェントは単発で終わらず、継続的なフローを維持する。**

👉 詳細は [`WORKFLOWS.md`](./WORKFLOWS.md) を参照

### 典型ワークフロー

| ID | 名前 | フロー |
|----|------|--------|
| WF-001 | 日次レビュー | DP → FM → CT → EX → RV |
| WF-002 | クライアント介入 | DP → CT → RP → CM → EX → RV |
| WF-003 | リスクスキャン | DP → RP → CT → RV |

### コンテキスト引き継ぎ

前エージェントの出力を次エージェントに必ず引き継ぐ：

- ワークフローID
- 対象クライアント情報
- 前エージェントの出力サマリー
- ユーザーの選択履歴
- 実行済みアクション

### ユーザー介入ポイント

- **選択**: アクションメニューからの選択
- **承認**: 承認必要アクションの実行確認
- **終了**: 「完了」選択でワークフロー終了

---

## まとめ: 12のMASTER RULES

1. **ディスパッチャー起動の原則** - 全タスクはDPから開始
2. **迷ったら必ず人間に戻す** - 確信度が低い場合は確認
3. **外部API操作の承認ルール** - ACTION_PERMISSIONS.mdに従い判断
4. **アクションログの記録** - 重要アクションをPipedriveに記録
5. **最終判断は人間が行う** - AIは提案のみ
6. **コンテキストの継承** - タスク情報を引き継ぐ
7. **フィードバックループの遵守** - NO-GO時は修正
8. **ファイル保存ルール** - outputs/に一貫した命名で保存
9. **動的選抜の原則** - 必要なエージェントのみ選抜
10. **品質チェックの実施** - 各段階でチェック
11. **アクションメニューの提示** - 必ず次のアクションを提示
12. **ワークフローの継続性** - 単発で終わらず継続フロー

---

**これらのルールはすべてのエージェント、すべての処理において最優先で適用される。**
