# ROUTING.md - ルーティング規約 v1.1

## 1. 基本原則

### ディスパッチャー起動必須

```
✅ 正しい: ユーザー指示 → DP → 各エージェント
❌ 間違い: ユーザー指示 → 直接エージェント起動
```

### ハイブリッドルーティング

```
定型タスク:   DP → 直接実行 → RV（任意）
非定型タスク: DP → FR → 各エージェント → RV
```

---

## 1.5 DPの初期インターフェース（重要）

### タスク開始時のフロー

```
ユーザー: 何かを依頼
    │
    ▼
DP: 初期インターフェースを表示
    │
    ├─ 番号入力（1-7）→ 定型ワークフロー実行
    │   └─ 必要に応じて追加情報を確認（例: クライアント名）
    │
    └─ 自然言語入力 → タスクタイプ判定
        │
        ├─ 明確 → 判定結果を表示して実行
        │
        └─ 不明確 → 逆質問（目的・アウトプット・制約）
```

### 初期インターフェース表示条件

| 条件 | 表示 |
|------|------|
| 新規会話開始 | ✅ 表示 |
| 曖昧な指示（「何かやって」等） | ✅ 表示 |
| ワークフロー完了後 | ✅ 表示（次のアクション選択） |
| 明確な指示（「〇〇社の状況を教えて」等） | ❌ スキップ、直接判定 |

### 定型ワークフロー番号

| # | ワークフロー | 追加入力 |
|---|-------------|---------|
| 1 | WF-001: 日次レビュー | なし |
| 2 | WF-002: クライアント介入 | クライアント名 |
| 3 | WF-003: リスクスキャン | なし |
| 4 | WF-004: フォローアップ実行 | なし |
| 5 | WF-005: 週次サマリー | なし |
| 6 | WF-006: クライアント360° | クライアント名 |
| 7 | WF-007: Slackサマリー | なし |

### 非定型タスクの定義項目

| 項目 | 必須 | 説明 |
|------|------|------|
| **目的** | ✅ | 何を達成したいか（1文） |
| **アウトプット** | ✅ | どんな形式で結果が欲しいか |
| **制約** | 任意 | 期限、対象範囲、注意点など |

**例**:
```
【目的】今月の歩留まり低下の原因を特定したい
【アウトプット】原因リストと対策案をレポート形式で
【制約】NEWT Chat契約パイプラインのみ対象
```

---

## 2. DPの判定ロジック

### Step 1: タスクタイプ判定

```
DP: ユーザー指示を分析
    │
    ├─ 定型タスク判定条件（いずれかに該当）
    │   - 単純な情報取得（「〜の状況は？」「〜を教えて」）
    │   - 定型フォーマット出力（「日次レポート」「週次サマリー」）
    │   - 明確な単一アクション（「メールを作成して」「日程を確認して」）
    │   → FRスキップ、直接実行
    │
    └─ 非定型タスク判定条件（いずれかに該当）
        - 分析・原因究明（「なぜ〜」「原因を分析」）
        - 戦略・計画立案（「検討して」「計画を立てて」）
        - 複数要素の比較判断（「最適な〜」「比較して」）
        - 複雑な条件（複数クライアント、複数要因）
        → FR経由
```

### Step 2: エージェント選抜

```
DP: キーワード分析
    │
    ├─ ファネル、パイプライン、CVR、歩留まり
    │   → FM選抜
    │
    ├─ クライアント、顧客、ステータス、ヘルス
    │   → CT選抜
    │
    ├─ リスク、チャーン、解約、警告
    │   → RP選抜
    │
    ├─ メール、フォローアップ、アクション、更新
    │   → EX選抜
    │
    ├─ コミュニケーション、連絡、タイミング
    │   → CM選抜
    │
    └─ 日程、MTG、アポ、スケジュール
        → SC選抜
```

### Step 3: RV必要性判定

```
DP: 重要度判定
    │
    ├─ 重要タスク（以下のいずれか）
    │   - Pipedriveへの書き込みを伴う
    │   - 戦略的判断を伴う
    │   - リスク対応
    │   - ユーザーへの最終報告
    │   → RV必須
    │
    └─ 軽微タスク
        - 単純な情報取得
        - 内部確認のみ
        → RV任意
```

---

## 3. ルーティングマトリクス

| タスク種類 | DP | FR | FM | CT | RP | EX | CM | SC | RV |
|---------|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|:--:|
| ファネル確認（定型） | ◎ | | ◎ | | | | | | △ |
| ファネル分析（非定型） | ◎ | ◎ | ◎ | △ | | ○ | | | ◎ |
| クライアント確認（定型） | ◎ | | | ◎ | | | | | △ |
| クライアント分析（非定型） | ◎ | ◎ | | ◎ | ○ | ○ | ○ | | ◎ |
| リスク評価 | ◎ | ◎ | | ◎ | ◎ | ○ | | | ◎ |
| メール作成（定型） | ◎ | | | △ | | ◎ | △ | | △ |
| コミュニケーション戦略 | ◎ | ◎ | | ◎ | | ○ | ◎ | | ◎ |
| 日程調整 | ◎ | | | | | | | ◎ | △ |
| 介入計画策定 | ◎ | ◎ | ○ | ◎ | ◎ | ◎ | ◎ | ○ | ◎ |

**凡例**:
- ◎必須 ○推奨 △任意 （空白）呼ばない

---

## 4. 代表的ルーティング例

### 例1: 今日のファネル状況確認（定型・2体）

```
ユーザー: 「今日のファネル状況を教えて」

DP判定: 定型タスク
  → FM選抜
  → RV不要（情報取得のみ）

実行: DP → FM
```

### 例2: クライアントステータス確認（定型・3体）

```
ユーザー: 「〇〇社の現在のステータスは？」

DP判定: 定型タスク
  → CT選抜
  → RV推奨

実行: DP → CT → RV
```

### 例3: 歩留まり低下の原因分析（非定型・5体）

```
ユーザー: 「今月の歩留まりが悪い原因を分析して対策を立てて」

DP判定: 非定型タスク（分析+計画）
  → FR必須
  → FM + CT + EX選抜
  → RV必須

実行: DP → FR → FM → CT → EX → RV
```

### 例4: リスククライアントへの介入（非定型・6体）

```
ユーザー: 「チャーンリスクの高い顧客を特定して介入計画を立てて」

DP判定: 非定型タスク（リスク+計画）
  → FR必須
  → CT + RP + EX + CM選抜
  → RV必須

実行: DP → FR → [CT + RP] → [EX + CM] → RV
```

### 例5: MTG日程調整（定型・3体）

```
ユーザー: 「来週の〇〇社とのMTG候補日を出して」

DP判定: 定型タスク
  → SC選抜
  → RV推奨

実行: DP → SC → RV
```

### 例6: フォローアップメール作成（定型・4体）

```
ユーザー: 「〇〇社へのフォローアップメールを作成して」

DP判定: 定型タスク
  → CT（情報取得）+ EX（メール作成）選抜
  → RV推奨

実行: DP → CT → EX → RV
```

---

## 5. フィードバックループ

```
RV判定
    │
    ├─ GO → 最終出力
    │
    ├─ CONDITIONAL-GO → Must Fix修正 → RV再レビュー
    │
    └─ NO-GO
        │
        ├─ 軽微 → 該当Agent差し戻し（最大3回）
        │
        ├─ 重大 → ユーザー確認 → 方針決定
        │
        └─ 前提崩壊 → DPからやり直し
```

---

## 6. 逆質問パス

```
FR/CT/他: 情報不足を検知
    │
    ├─ 致命的（タスク実行不可）
    │   → ユーザーに逆質問（処理停止）
    │
    └─ 軽微（推測で補完可能）
        → 「仮置きで進めてよいか」確認
          │
          ├─ 承諾 → 続行
          └─ 拒否 → 情報提供待ち
```

---

## 7. 人間確認が必要なケース

| ケース | タイミング | アクション |
|--------|-----------|-----------|
| 情報不足 | FR/CT段階 | 逆質問 |
| 判断が割れる | 分析段階 | 選択肢提示 |
| Pipedrive書き込み | EX段階 | 操作確認 |
| RV: NO-GO（3回） | RV段階 | ユーザーに報告 |
| リスク高い判断 | 全段階 | リスク明示して確認 |

---

## 8. 並列実行ルール

### 並列実行可能

```
DP → [CT + RP]（並列）→ EX → RV
DP → FR → [FM + CT]（並列）→ EX → RV
```

### 並列実行不可（依存関係あり）

```
✅ CT → EX（CTの出力をEXが使用）
✅ FM → CT（FMの分析をCTが参照）
❌ [CT → EX]（並列不可）
```

---

## 9. 選抜アルゴリズム（Main向け）

### Step 1: DP起動（必須）

```
DP → タスク判定 → タスクタイプ確定
```

### Step 2: FR必要性判定

```
タスクタイプ:
  - 定型 → FRスキップ
  - 非定型 → FR起動
```

### Step 3: 実行エージェント選抜（0-4体）

```
キーワードマッチング:
  - ファネル関連 → FM
  - クライアント関連 → CT
  - リスク関連 → RP
  - アクション関連 → EX
  - コミュニケーション関連 → CM
  - 日程関連 → SC
```

### Step 4: RV必要性判定

```
重要度:
  - 高（書き込み、判断、報告）→ RV必須
  - 中（分析、計画）→ RV推奨
  - 低（情報取得のみ）→ RV任意
```

### Step 5: 体数確認

```
合計体数:
  - 4体以下 → OK
  - 5-6体 → 許容範囲
  - 7体以上 → ユーザーに確認
```

---

## 10. まとめ

### 鉄則

1. **DP必須**: 常に最初
2. **ハイブリッド**: 定型/非定型で分岐
3. **動的選抜**: 2〜6体が標準
4. **RV推奨**: 重要タスクでは必須
5. **人間確認**: 迷ったら必ず確認

### 禁止事項

- ❌ DPをスキップ
- ❌ 全9体を同時起動
- ❌ 非定型タスクでFRをスキップ
- ❌ RVのNO-GOを無視
- ❌ Pipedrive書き込みを無断実行
